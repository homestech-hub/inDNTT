<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu ƒê·ªÅ Ngh·ªã Thanh To√°n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .toolbar {
            background: #2563eb;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar h1 {
            font-size: 18px;
            font-weight: bold;
        }

        .toolbar-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-print {
            background: #10b981;
            color: white;
        }

        .btn-print:hover {
            background: #059669;
        }

        .btn-pdf {
            background: #dc2626;
            color: white;
        }

        .btn-pdf:hover {
            background: #b91c1c;
        }

        .form-wrapper {
            padding: 20px;
        }

        /* A5 Landscape Print Styles */
        .phieu-form {
            width: 210mm;
            height: 148mm;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
            padding: 15mm;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 15px;
        }

        .company-name {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .form-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
            color: #2563eb;
        }

        .form-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }

        .label {
            font-weight: bold;
            min-width: 100px;
            color: #374151;
        }

        .value {
            flex: 1;
            padding: 4px 8px;
            border: none;
            border-bottom: 1px solid #ccc;
            font-size: 13px;
            background: transparent;
        }

        .content-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #1f2937;
            font-size: 14px;
        }

        .content-area {
            border: 1px solid #ccc;
            min-height: 60px;
            padding: 10px;
            font-size: 13px;
            line-height: 1.4;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .signature-box {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .signature-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .signature-date {
            font-size: 11px;
            color: #666;
            margin-bottom: 30px;
        }

        .signature-name {
            font-weight: bold;
            font-size: 12px;
            border-top: 1px solid #ccc;
            padding-top: 5px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .toolbar {
                display: none;
            }

            .form-wrapper {
                padding: 0;
            }

            .phieu-form {
                border: none;
                margin: 0;
                width: 100%;
                height: 100vh;
            }

            @page {
                size: A5 landscape;
                margin: 10mm;
            }
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-message {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <h1>üìã Phi·∫øu ƒê·ªÅ Ngh·ªã Thanh To√°n</h1>
            <div class="toolbar-buttons">
                <button class="btn btn-print" onclick="printForm()">üñ®Ô∏è In Phi·∫øu</button>
                <button class="btn btn-pdf" onclick="exportToPDF()">üìÑ Xu·∫•t PDF</button>
            </div>
        </div>

        <div class="form-wrapper">
            <div id="loading" class="loading">
                <p>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>

            <div id="error-message" class="error" style="display: none;">
                <p>‚ùå C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!</p>
            </div>

            <div id="info-message" class="info-message" style="display: none;">
                <p>‚ÑπÔ∏è S·ª≠ d·ª•ng URL v·ªõi tham s·ªë ƒë·ªÉ t·∫£i d·ªØ li·ªáu. V√≠ d·ª•: ?id=1&maDNMH=DN001&ngayTao=2024-01-15</p>
            </div>

            <div class="phieu-form" id="phieu-form" style="display: none;">
                <div class="header">
                    <div class="company-name">C√îNG TY C·ªî PH·∫¶N ƒê·∫¶U T∆Ø PH√ÅT TRI·ªÇN C√îNG NGH·ªÜ HOMESTECH</div>
                    <div class="form-title">Phi·∫øu ƒê·ªÅ Ngh·ªã Thanh To√°n</div>
                    <div style="font-size: 12px;">M√£ phi·∫øu: <span id="ma-phieu" style="font-weight: bold; color: #2563eb;"></span></div>
                </div>

                <div class="form-info">
                    <div class="info-group">
                        <div class="info-row">
                            <span class="label">ID:</span>
                            <span class="value" id="id-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ng√†y t·∫°o:</span>
                            <span class="value" id="ngay-tao"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Nh√† cung c·∫•p:</span>
                            <span class="value" id="nha-cung-cap"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</span>
                            <span class="value" id="nguoi-de-nghi"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Gi√°m ƒê·ªëc Duy·ªát:</span>
                            <span class="value" id="Ten-giam-doc"></span>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-row">
                            <span class="label">H√¨nh th·ª©c TT:</span>
                            <span class="value" id="hinh-thuc-tt"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">S·ªë TK:</span>
                            <span class="value" id="so-tk"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">S·ªë ti·ªÅn:</span>
                            <span class="value" id="so-tien" style="font-weight: bold; color: #dc2626;"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Tr·∫°ng th√°i:</span>
                            <span class="status-badge" id="trang-thai"></span>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-title">L√Ω do thanh to√°n:</div>
                    <div class="content-area" id="ly-do-tt"></div>
                </div>

                <div class="signature-section">
                    <div class="signature-box">
                        <div class="signature-title">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã</div>
                        <div class="signature-date" id="ngay-de-nghi">Ng√†y ... th√°ng ... nƒÉm ...</div>
                        <div class="signature-name" id="ten-nguoi-de-nghi"></div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Ph·ª• tr√°ch ph√≤ng ban</div>
                        <div class="signature-date">Ng√†y ... th√°ng ... nƒÉm ...</div>
                        <div class="signature-name">(...................................)</div>
                    </div>
                    <div class="signature-box">
                        <div class="signature-title">Gi√°m ƒë·ªëc duy·ªát</div>
                        <div class="signature-date" id="ngay-duyet">Ng√†y ... th√°ng ... nƒÉm ...</div>
                        <div class="signature-name" id="ten-giam-Doc"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Parse URL parameters
        function getURLParams() {
            const params = {};
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams) {
                params[key] = value;
            }
            return params;
        }

        // Format currency
        function formatCurrency(amount) {
            if (!amount) return '';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // Get status badge class
        function getStatusClass(status) {
            switch (status?.toLowerCase()) {
                case 'approved':
                case 'ƒë√£ duy·ªát':
                    return 'status-approved';
                case 'rejected':
                case 't·ª´ ch·ªëi':
                    return 'status-rejected';
                default:
                    return 'status-pending';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch (status?.toLowerCase()) {
                case 'approved':
                    return 'ƒê√£ duy·ªát';
                case 'rejected':
                    return 'T·ª´ ch·ªëi';
                case 'pending':
                    return 'Ch·ªù duy·ªát';
                default:
                    return status || 'Ch·ªù duy·ªát';
            }
        }

        // Load form data
        function loadFormData() {
            const loading = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const infoMessage = document.getElementById('info-message');
            const form = document.getElementById('phieu-form');

            try {
                const params = getURLParams();

                // Check if we have any parameters
                if (Object.keys(params).length === 0) {
                    loading.style.display = 'none';
                    infoMessage.style.display = 'block';
                    return;
                }

                // Fill form data
                document.getElementById('id-value').textContent = params.id || '';
                document.getElementById('ma-phieu').textContent = params.MaDNMH || params.maDNMH || '';
                document.getElementById('ngay-tao').textContent = formatDate(params.NgayTao || params.ngayTao);
                document.getElementById('nha-cung-cap').textContent = params.NhaCungCap || params.nhaCungCap || '';
                document.getElementById('hinh-thuc-tt').textContent = params.HinhThucTT || params.hinhThucTT || '';
                document.getElementById('so-tk').textContent = params.SoTK || params.soTK || '';
                document.getElementById('so-tien').textContent = formatCurrency(params.SoTien || params.soTien);
                document.getElementById('nguoi-de-nghi').textContent = params.NguoiDeNghi || params.nguoiDeNghi || '';
                document.getElementById('ly-do-tt').textContent = params.LyDoTT || params.lyDoTT || '';
                
                // Status handling
                const status = params.TrangThaiDuyet || params.trangThaiDuyet || 'pending';
                const statusElement = document.getElementById('trang-thai');
                statusElement.textContent = getStatusText(status);
                statusElement.className = 'status-badge ' + getStatusClass(status);

                // Set signature dates
                const ngayTao = params.NgayTao || params.ngayTao;
                if (ngayTao) {
                    document.getElementById('ngay-de-nghi').textContent = 'Ng√†y ' + formatDate(ngayTao);
                }

                const tgDuyet = params.TGGDDuyet || params.tgGDDuyet;
                if (tgDuyet) {
                    document.getElementById('ngay-duyet').textContent = 'Ng√†y ' + formatDate(tgDuyet);
                }

                // Set requester name in signature
                const nguoiDeNghi = params.NguoiDeNghi || params.nguoiDeNghi;
                if (nguoiDeNghi) {
                    document.getElementById('ten-nguoi-de-nghi').textContent = nguoiDeNghi;
                }

                // Hide loading and show form
                loading.style.display = 'none';
                errorMessage.style.display = 'none';
                infoMessage.style.display = 'none';
                form.style.display = 'block';

            } catch (error) {
                console.error('Error loading data:', error);
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.innerHTML = '<p>‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message + '</p>';
            }
        }

        // Print function
        function printForm() {
            window.print();
        }

        // Export to PDF function
        function exportToPDF() {
            const element = document.getElementById('phieu-form');
            const maDNMH = document.getElementById('ma-phieu').textContent || 'DNMH';
            
            const options = {
                margin: 0.5,
                filename: `Phieu_${maDNMH}_${new Date().toISOString().slice(0,10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'in', 
                    format: [8.27, 5.83], // A5 landscape in inches
                    orientation: 'landscape'
                }
            };

            // Show loading state
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ ƒêang xu·∫•t...';
            btn.disabled = true;

            html2pdf().set(options).from(element).save().then(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }).catch(error => {
                console.error('Error generating PDF:', error);
                alert('C√≥ l·ªói khi xu·∫•t PDF. Vui l√≤ng th·ª≠ l·∫°i.');
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadFormData);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                if (e.key === 'p') {
                    e.preventDefault();
                    printForm();
                } else if (e.key === 's') {
                    e.preventDefault();
                    exportToPDF();
                }
            }
        });

        // Add some sample data for testing (remove in production)
        if (window.location.search === '') {
            const sampleParams = new URLSearchParams({
                id: '1',
                MaDNMH: 'DN2024001',
                NgayTao: '2024-01-15',
                NhaCungCap: 'C√¥ng ty ABC',
                HinhThucTT: 'Chuy·ªÉn kho·∫£n',
                SoTK: '123456789',
                SoTien: '5000000',
                NguoiDeNghi: 'Nguy·ªÖn VƒÉn A',
                LyDoTT: 'Mua thi·∫øt b·ªã vƒÉn ph√≤ng cho ph√≤ng IT',
                TrangThaiDuyet: 'pending',
                TGGDDuyet: ''
            });
            
            // Update URL with sample data for demo
            // window.history.replaceState({}, '', '?' + sampleParams.toString());
            // loadFormData();
        }
    </script>
</body>
</html>
